#!/usr/bin/env node
'use strict';

const debug = require('debug')('roleBase');
const fs = require('fs');
const app = require('../app');
const path = require('path');
const logger = require('../logger');
const minifier = require('../minifier');
const config = require('../config/serverConfig');

/**
 * Minifies all files in the directories with a specific extension
 *
 * @returns {undefined} Returns undefined
 */
function minifyDirs() {
  minifier.minifyDir(
      path.resolve(path.join(config.privateBase, config.paths.views)),
      path.resolve(path.join(config.publicBase, config.paths.views)),
      'html'
  );
  minifier.minifyDir(
      path.resolve(path.join(config.privateBase, config.paths.styles)),
      path.resolve(path.join(config.publicBase, config.paths.styles)),
      'css'
  );
  minifier.minifyDir(
    path.resolve(
      path.join(config.privateBase, config.paths.scripts)),
      path.resolve(path.join(config.publicBase, config.paths.scripts)),
      'js'
  );
}

/*
 * Checks if the public directory.
 * Creats it if it doesn't exist
 */
fs.stat(path.resolve(config.publicBase), function(err) {
  if (err) {
    fs.mkdir(path.resolve(config.publicBase), function(dirErr) {
      logger.sendErrorMsg(logger.ErrorCodes.general, 'Mkdir error', dirErr);
    });
  }

  minifyDirs();
});

// Sets server port
app.set('port', config.port);

/*
 * Starts Express server
 */
const server = app.listen(app.get('port'), function() {
  debug('Express server listening on port ' + server.address().port);
});

// SocketIO
const io = app.io;

io.attach(server);
